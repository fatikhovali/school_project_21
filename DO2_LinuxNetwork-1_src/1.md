## Part 1. Инструмент ipcalc
----
* ipcalc - выполняет простые операции с IP-адресами  
Для установки утилиты ipcalc следует ввести следующую команду:
`sudo apt install ipcalc`
![1](./image/1.png)

#### 1.1. Сети и маски
##### 1) Определяем адрес сети 192.167.38.54/13 с помощью команды
`ipcalc 192.167.38.54/13`
![2](./image/2.png)
##### 2) Перевод маски:
`ipcalc 192.167.38.54/255.255.255.0`
- префиксная форма записи /24
- двоичная форма записи 11111111.11111111.11111111.00000000
![3](./image/3.png)
`ipcalc 192.167.38.54/15`
- обычная форма записи 255.254.0.0
- двоичная 11111111.1111111 0.00000000.00000000
![4](./image/4.png)
`ipcalc 192.167.38.54/11111111.11111111.11111111.11110000`
![5](./image/5.png)
![6](./image/6.png)
![7](./image/7.png)

##### 3) минимальный и максимальный хост в сети *12.167.38.4* при масках: 
`ipcalc 12.167.38.4/8`
- минимальный хост 12.0.0.1
- максимальный хост 12.255.255.254
![8](./image/8.png)
`ipcalc 12.167.38.4/11111111.11111111.00000000.00000000`
- минимальный хост 12.167.38.1
- максимальный хост 12.167.38.254
![9](./image/9.png)
`ipcalc 12.167.38.4/16`
- минимальный хост 12.167.0.1
- максимальный хост 12.167.255.254
![10](./image/10.png)
`ipcalc 12.167.38.4/255.255.254.0`
- минимальный хост 12.167.38.1
- максимальный хост 12.167.38.254
![11](./image/11.png)
`ipcalc 12.167.38.4/23`
- минимальный хост 12.167.38.1
- максимальный хост 12.167.39.254
![12](./image/12.png)
`ipcalc 12.167.38.4/4`
- минимальный хост 0.0.0.1
- максимальный хост 15.255.255.254
![13](./image/13.png)

#### 1.2. localhost
##### Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*
- приложения к которым можно обратиться через localhost: 127.0.0.2, 127.1.0.1
`ipcalc 127.0.0.2`
![14](./image/14.png)
`ipcalc 127.1.0.2`
![15](./image/15.png)
- приложения к которым нельзя обратиться через localhost: 194.34.23.100, 128.0.0.1
`ipcalc 194.34.23.100`
![16](./image/16.png)
`ipcalc 128.0.0.1`
![17](./image/17.png)

#### 1.3. Диапазоны и сегменты сетей
##### 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*
Публичный IP адрес - называется IP адрес, который используется для выхода в Интернет. Частный IP адрес - адреса, используемые в локальных сетях (не может быть напрямую подключен к Интернету).
- к публичным относятся следующие IP адреса: 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1, 134.43.0.2.
![18](./image/18.png)
![19](./image/19.png)
![20](./image/20.png)
![21](./image/21.png)
![22](./image/22.png)
- к частным относятся следующие IP адреса: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10
![23](./image/23.png)
![24](./image/24.png)
![25](./image/25.png)
![26](./image/26.png)
![27](./image/27.png)
##### 2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*
`-`10.10.0.2 
`-`10.10.10.10 
`-`10.10.1.255


## Part 2. Статическая маршрутизация между двумя машинами
#### Поднять две виртуальные машины (далее -- ws1 и ws2)
#### С помощью команды ip a посмотреть существующие сетевые интерфейсы
![28](./image/28.png)
![29](./image/29.png)
#####1) lo или local loopback (локальная петля). Служит для подключения по сети к этому же компьютеру и не требует дополнительной настройки;
``` brew
* ws1: 127.0.0.1/8;
* ws2: 127.0.0.1/8;
```
##### 2) enp0s3 - первый сетевой адаптер работающий в NAT режиме. 
``` brew
* ws1: 10.0.2.15/24;
* ws2: 10.0.2.15/24.
```
#### Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: 
``` brew 
ws1 - 192.168.100.10, маска /16,
ws2 - 172.24.116.8, маска /12           
sudo vim /etc/netplan/00-installer-config.yaml
```
#### Выполнить команду netplan apply для перезапуска сервиса сети
`netplan apply`
![30](./image/30.png)
![31](./image/31.png)
### Добавление статического маршрута вручную
#### Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add
``` brew 
sudo ip r add 172.24.116.8 dev enp0s3//ws1
sudo ip r add 192.168.100.10 dev enp0s3//ws2
```
#### Пропинговать соединение между машинами
``` brew
ping 172.24.116.8 //ws1
ping 192.168.100.10 //ws2
```
![32](./image/32.png)
![33](./image/33.png)
### Добавление статического маршрута с сохранением
#### Перезапустить машины
`sudo netplan apply`
#### Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml
`sudo vim /etc/netplan/00-installer-config.yaml`

#### Пропинговать соединение между машинами
![32](./image/34.png)
![33](./image/35.png)

## Part 3. Утилита **iperf3**
### Скорость соединения
Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps
``` brew
8Mbps == 1MB/s;
100MB/s == 819200 Kbps;
1Gbps == 1024 Mbps.
``` 
### Утилита iperf3
Измерить скорость соединения между ws1 и ws2:
![36](./image/36.png)
![37](./image/37.png)

## Part 4. Сетевой экран
### Утилита iptables
Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2.
Нужно добавить в файл подряд следующие правила:
1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
4) запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
5) разрешить echo reply (машина должна "пинговаться")
- ws1:
![38](./image/38.png)
- ws2:
![39](./image/39.png)
Запустить файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh
- ws1:
![40](./image/40.png)
- ws2:
![41](./image/41.png)
- Разница между стратегиями заключается в том, что в первом файле первым подходящим правилом для пакета является запрет, а во втором - разрешение. Применяется только первое подходящее правило, остальные игнорируются.
### Утилита nmap
Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен
![42](./image/42.png)
![43](./image/43.png)
* Видно из скрина что, хост 1ой машины запущен, но не пингуется

## Part 5. Статическая маршрутизация сети
Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))
![44](./image/44.png)
### Настройка адресов машин
Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.
![45](./image/45.png)
![46](./image/46.png)
![47](./image/47.png)
![48](./image/48.png)
![49](./image/49.png)
Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.
* ip -4 a
![50](./image/50.png)
![51](./image/51.png)
![52](./image/52.png)
![53](./image/53.png)
![54](./image/54.png)
* пропинговать ws22 с ws21
![55](./image/55.png)
* пропинговать r1 с ws11
![56](./image/56.png)
### Включение переадресации IP-адресов.
Для включения переадресации IP, выполните команду на роутерах:
* sysctl -w net.ipv4.ip_forward=1
![57](./image/57.png)
![58](./image/58.png)
Откройте файл /etc/sysctl.conf и добавьте в него следующую строку:
* net.ipv4.ip_forward = 1
![59](./image/59.png)
![60](./image/60.png)
### Установка маршрута по-умолчанию
Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить gateway4 [ip роутера] в файле конфигураций
Вызвать ip r и показать, что добавился маршрут в таблицу маршрутизации
* ip r
![61](./image/61.png)
![62](./image/62.png)
![63](./image/63.png)
Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
* tcpdump -tn -i eth1
![64](./image/64.png)
![65](./image/65.png)
### Добавление статических маршрутов
Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.
![66](./image/66.png)
![67](./image/67.png)
Вызвать ip r и показать таблицы с маршрутами на обоих роутерах. Пример таблицы на r1:
* ip r
![69](./image/68.png)
![68](./image/69.png)
Запустить команды на ws11:
``` brew
ip r list 10.10.0.0/[18]
ip r list 0.0.0.0/0
```
![70](./image/70.png)
Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, поскольку он является адресом сети и доступен без шлюза.
### Построение списка маршрутизаторов
Запустить на r1 команду дампа
* tcpdump -tnv -i eth0
При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21
![71](./image/71.png)
![72](./image/72.png)
Для определения промежуточных маршрутизаторов traceroute отправляет целевому узлу серию ICMP-пакетов (по умолчанию 3 пакета), с каждым шагом увеличивая значение поля TTL («время жизни») на 1. Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первая серия пакетов отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно ICMP-сообщение «time exceeded in transit», указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку серии пакетов, но уже с TTL, равным 2, что заставляет первый маршрутизатор уменьшить TTL пакетов на единицу и направить их ко второму маршрутизатору. Второй маршрутизатор, получив пакеты с TTL=1, так же возвращает «time exceeded in transit».

Процесс повторяется до тех пор, пока пакет не достигнет целевого узла, тем самым увеличивая значение ttl. При получении ответа от этого узла процесс трассировки считается завершённым.
### Использование протокола ICMP при маршрутизации
Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
``` brew
tcpdump -n -i eth0 icmp
```
Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:
* ping -c 1 10.30.0.111
![73](./image/73.png)
![74](./image/74.png)

## Part 6. Динамическая настройка IP с помощью **DHCP**
Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:
1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. 
![75](./image/75.png)
2) в файле resolv.conf прописать nameserver 8.8.8.8.
![76](./image/76.png)
Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес. Также пропинговать ws22 с ws21.
* systemctl restart isc-dhcp-server // r2
![77](./image/77.png)
``` brew
reboot // ws21
ip a // ws 21
```
![78](./image/78.png)
Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true
![79](./image/79.png)
Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты
В файле /etc/dhcp/dhcpd.conf настроить конфигурацию службы DHCP с жесткой привязкой к MAC-адресу (ws11)
![80](./image/80.png)
в файле resolv.conf прописать nameserver 8.8.8.8 (DNS)
![81](./image/81.png)
Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server. Машину ws11 перезагрузить при помощи reboot и через ip a показать, что она получила адрес.
* systemctl restart isc-dhcp-server // r1
![82](./image/82.png)
``` brew
reboot // ws11
ip a // ws 11
```
![83](./image/83.png)
Запросить с ws21 обновление ip адреса
В отчёте поместить скрины ip до и после обновления
* До обновления
![84](./image/84.png)
Обновление с помощью следующих команд:
``` brew
sudo dhclient -r enp0s3
sudo dhclient enp0s3
```
* После обноваления
![85](./image/85.png)

## Part 7. **NAT**
В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным
![86](./image/86.png)
![87](./image/87.png)
Запустить веб-сервер Apache командой service apache2 start на ws22 и r1
![88](./image/88.png)
![89](./image/89.png)
Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
1) Удаление правил в таблице filter - iptables -F
2) Удаление правил в таблице "NAT" - iptables -F -t nat
3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP
![90](./image/90.png)
Запускать файл также, как в Части 4
Проверить соединение между ws22 и r1 командой ping
При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1
![91](./image/91.png)
![92](./image/92.png)
Добавить в файл ещё одно правило:
4) Разрешить маршрутизацию всех пакетов протокола ICMP
![93](./image/93.png)
Запускать файл также, как в Части 4
Проверить соединение между ws22 и r1 командой ping
При запуске файла с этими правилами, ws22 должна "пинговаться" с r1
![94](./image/94.png)
![95](./image/95.png)
Добавить в файл ещё два правила:
5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
![96](./image/96.png)
Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой:
* telnet 10.100.0.11 80
![97](./image/97.png)
Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)
* telnet 10.100.0.12 8080
![98](./image/98.png)

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**
Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)
![99](./image/99.png)
Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
![100](./image/100.png)
![101](./image/101.png)
Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11
![102](./image/102.png)
Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:
![103](./image/103.png)
![104](./image/104.png)

